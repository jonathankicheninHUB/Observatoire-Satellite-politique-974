<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saint-André - Intelligence Territoriale</title>
    
    <!-- 1. Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Leaflet CSS (Carte) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- 3. React & ReactDOM (Framework) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel (Pour comprendre le code React dans le navigateur) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Lucide Icons (Icônes) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Styles personnalisés pour la carte */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #0f172a; }
        #root { height: 100%; width: 100%; }
        .custom-marker-icon { background: transparent; border: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Scrollbar fine */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 6. Script Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 7. Notre Application React -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration des données
        const DATA = {
            synthese: {
                population: "57 000",
                croissance: "+1.2%",
                familles_monoparentales: "38%",
                vote_rn_2022: "53.9%",
                analyse: "Saint-André agit comme un 'verrou' de l'Est. La ville est fragmentée entre le Centre-Ville (pouvoir historique) et les 'Écarts' (Fayard, Cambuston)."
            },
            politique: [
                {
                    nom: "Joé Bédier", titre: "Maire (DVG)", statut: "En place (fragilisé par insécurité)",
                    desc: "A brisé l'hégémonie Virapoullé en 2020. Stratégie d'alliance large. Décoré légion d'honneur.",
                    color: "text-pink-500", bg: "bg-pink-500/20", score: "52.16%"
                },
                {
                    nom: "J-M Virapoullé", titre: "Opp. (DVD)", statut: "Opposition (47.8% en 2020)",
                    desc: "Héritier du système familial. Peine à élargir sa base électorale face à la montée du RN.",
                    color: "text-blue-400", bg: "bg-blue-400/20", score: "47.84%"
                },
                {
                    nom: "J-H Ratenon", titre: "Député (LFI)", statut: "Réélu 2024 (54%)",
                    desc: "Force politique majeure. Capte le vote populaire radical dans les quartiers.",
                    color: "text-red-500", bg: "bg-red-500/20", score: "54.08%"
                }
            ],
            securite: {
                alertes: [
                    { label: "Cambriolages", val: "+111%", color: "text-red-500" },
                    { label: "Vols Véhicules", val: "+66%", color: "text-orange-500" },
                    { label: "Trafic Stups", val: "+45%", color: "text-yellow-500" },
                    { label: "Violences", val: "+40%", color: "text-purple-500" }
                ],
                focus: {
                    titre: "Focus: Le Complexe Fayard",
                    desc: "Épicentre des tensions. Émeutes récurrentes (mai/sept 2025). Incendie du collège. Zone de 'non-droit' potentielle."
                }
            },
            quartiers: [
                { id: 1, nom: "Fayard / Petit Bazar", coords: [-20.945, 55.665], type: "Tension Maximale", color: "red" },
                { id: 2, nom: "Centre-Ville", coords: [-20.960, 55.650], type: "Pouvoir Historique", color: "blue" },
                { id: 3, nom: "Cambuston", coords: [-20.975, 55.630], type: "Quartier Pivot", color: "orange" },
                { id: 4, nom: "La Cressonnière", coords: [-20.980, 55.645], type: "Enclavement", color: "green" }
            ]
        };

        // Icônes SVG simples pour éviter les dépendances lourdes
        const Icons = {
            Users: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            AlertTriangle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            TrendingUp: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            MapPin: () => <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
            Database: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>,
            Menu: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        };

        function App() {
            const [activeTab, setActiveTab] = useState('synthese');
            const [mapCenter, setMapCenter] = useState([-20.960, 55.650]);
            const [selectedQuarter, setSelectedQuarter] = useState(null);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            // Init Carte
            useEffect(() => {
                if (!mapInstanceRef.current && window.L) {
                    const map = window.L.map(mapContainerRef.current, {
                        center: [-20.960, 55.650],
                        zoom: 13,
                        zoomControl: false,
                        attributionControl: false
                    });

                    // Fond de carte Satellite (ESRI - Gratuit)
                    window.L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri',
                        maxZoom: 18
                    }).addTo(map);

                    mapInstanceRef.current = map;
                    updateMarkers(map);
                }
            }, []);

            // Mise à jour vue
            useEffect(() => {
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.flyTo(mapCenter, 14, { duration: 2 });
                    updateMarkers(mapInstanceRef.current);
                }
            }, [mapCenter]);

            const updateMarkers = (map) => {
                // Nettoyage
                markersRef.current.forEach(m => m.remove());
                markersRef.current = [];

                const colors = { red: "#ef4444", blue: "#3b82f6", orange: "#f97316", green: "#22c55e" };

                DATA.quartiers.forEach(q => {
                    const color = colors[q.color];
                    const iconHtml = `<svg width="40" height="40" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.5));"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>`;
                    
                    const icon = window.L.divIcon({
                        className: 'custom-marker-icon',
                        html: iconHtml,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    });

                    const marker = window.L.marker(q.coords, { icon: icon }).addTo(map);
                    
                    const popupContent = `
                        <div style="font-family: sans-serif; color: #0f172a; min-width: 150px; text-align: center;">
                           <h3 style="font-weight: bold; font-size: 14px; text-transform: uppercase; margin: 0 0 4px 0;">${q.nom}</h3>
                           <span style="font-size: 10px; color: white; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; background-color: ${color}; display: inline-block;">
                              ${q.type}
                           </span>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    marker.on('click', () => {
                        setActiveTab('synthese');
                        setSelectedQuarter(q);
                        setMapCenter(q.coords);
                        if (window.innerWidth < 768) setIsMobileMenuOpen(true);
                    });
                    markersRef.current.push(marker);
                });
            };

            return (
                <div className="flex h-screen w-full bg-slate-900 text-white overflow-hidden font-sans relative">
                    
                    {/* SIDEBAR */}
                    <div className={`
                        absolute z-[1000] top-4 left-4 bottom-4 w-96 
                        bg-slate-900/90 backdrop-blur-xl border border-slate-700/50 
                        rounded-2xl shadow-2xl flex flex-col transition-transform duration-300
                        ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-[110%] md:translate-x-0'}
                    `}>
                        <div className="p-6 border-b border-slate-700/50">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>
                                <h1 className="text-xl font-bold tracking-wider">SAINT-ANDRÉ <span className="text-xs bg-blue-600 px-1.5 py-0.5 rounded text-white ml-2">97440</span></h1>
                            </div>
                            <p className="text-xs text-slate-400 uppercase tracking-widest">Rapport d'Intelligence Stratégique</p>
                        </div>

                        <div className="flex border-b border-slate-700/50 text-xs font-medium">
                            {['synthese', 'politique', 'securite', 'data'].map((tab) => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`flex-1 py-3 hover:bg-slate-800/50 transition-colors uppercase ${activeTab === tab ? 'text-blue-400 border-b-2 border-blue-400 bg-slate-800/30' : 'text-slate-500'}`}>
                                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {activeTab === 'synthese' && (
                                <div className="space-y-6 animate-fadeIn">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                            <p className="text-xs text-slate-400 uppercase mb-1">Population</p>
                                            <p className="text-2xl font-bold text-white">{DATA.synthese.population}</p>
                                            <p className="text-xs text-green-400 flex items-center gap-1"><Icons.TrendingUp/> {DATA.synthese.croissance}</p>
                                        </div>
                                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                            <p className="text-xs text-slate-400 uppercase mb-1">Familles Monop.</p>
                                            <p className="text-2xl font-bold text-pink-400">{DATA.synthese.familles_monoparentales}</p>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-5 rounded-xl border border-slate-700 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-2 opacity-10 text-white"><Icons.MapPin/></div>
                                        <h3 className="text-blue-400 font-bold mb-2">Analyse Morphologique</h3>
                                        <p className="text-sm text-slate-300 leading-relaxed">{DATA.synthese.analyse}</p>
                                    </div>
                                     <div className="space-y-2">
                                        {DATA.quartiers.map(q => (
                                            <div key={q.id} onClick={() => { setMapCenter(q.coords); setSelectedQuarter(q); }}
                                                className={`p-3 rounded-lg border border-slate-700 cursor-pointer hover:bg-slate-800 flex justify-between ${selectedQuarter?.id === q.id ? 'bg-slate-800 border-blue-500' : 'bg-slate-800/30'}`}>
                                                <div><p className="font-bold text-sm text-slate-300">{q.nom}</p><p className="text-[10px] text-slate-500 uppercase">{q.type}</p></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'politique' && (
                                <div className="space-y-4 animate-fadeIn">
                                    {DATA.politique.map((p, idx) => (
                                        <div key={idx} className="bg-slate-800/40 border border-slate-700 rounded-xl p-4">
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${p.bg} ${p.color}`}>{p.nom.charAt(0)}</div>
                                                <div><h4 className="font-bold text-white">{p.nom}</h4><span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${p.bg} ${p.color}`}>{p.titre}</span></div>
                                            </div>
                                            <p className="text-xs text-slate-400 mb-2">{p.desc}</p>
                                            <div className="w-full bg-slate-700 h-1.5 rounded-full"><div className="h-full bg-blue-500" style={{ width: p.score }}></div></div>
                                            <div className="flex justify-between mt-1 text-[10px] text-slate-500"><span>Puissance</span><span>{p.score}</span></div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 'securite' && (
                                <div className="space-y-6 animate-fadeIn">
                                    <div className="bg-red-500/10 border border-red-500/50 p-4 rounded-xl">
                                        <div className="flex items-center gap-2 mb-2 text-red-500"><Icons.AlertTriangle/> <h3 className="font-bold text-sm uppercase">Alerte Délinquance</h3></div>
                                        <p className="text-xs text-red-200/70">Indicateurs au rouge vif.</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {DATA.securite.alertes.map((item, idx) => (
                                            <div key={idx} className="bg-slate-800/50 p-3 rounded-lg border border-slate-700 text-center">
                                                <p className={`text-2xl font-black ${item.color}`}>{item.val}</p>
                                                <p className="text-[10px] uppercase text-slate-400 font-bold mt-1">{item.label}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                             {activeTab === 'data' && (
                                <div className="space-y-4 animate-fadeIn">
                                    <div className="bg-slate-950 p-4 rounded-xl border border-slate-800 font-mono text-xs text-green-400 overflow-x-auto shadow-inner">
                                        <div className="flex items-center gap-2 text-slate-500 mb-2 border-b border-slate-800 pb-2"><Icons.Database/> REQ: Zones Abstention</div>
                                        <p className="opacity-80"><span className="text-purple-400">SELECT</span> * <span className="text-purple-400">FROM</span> bureaux_vote <span className="text-purple-400">WHERE</span> abstention &gt; 50%;</p>
                                    </div>
                                    <table className="w-full text-xs text-left">
                                        <thead><tr className="text-slate-500 border-b border-slate-700"><th className="pb-2">Bureau</th><th className="pb-2">Score RN</th><th className="pb-2">Abst.</th></tr></thead>
                                        <tbody className="text-slate-300">
                                            <tr className="border-b border-slate-800/50"><td className="py-2">Fayard</td><td className="text-purple-400">58%</td><td className="text-orange-400">52%</td></tr>
                                            <tr className="border-b border-slate-800/50"><td className="py-2">Petit Bazar</td><td className="text-purple-400">55%</td><td className="text-orange-400">49%</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="absolute top-4 right-4 z-[1001] md:hidden bg-slate-800 p-2 rounded-lg text-white border border-slate-600">
                        {isMobileMenuOpen ? <Icons.X/> : <Icons.Menu/>}
                    </button>

                    <div className="flex-1 h-full relative z-0">
                        <div ref={mapContainerRef} style={{ height: "100%", width: "100%", background: "#0f172a" }} />
                        <div className="absolute inset-0 pointer-events-none bg-radial-gradient from-transparent via-transparent to-black/60 z-[400]" style={{background: 'radial-gradient(circle, transparent 50%, rgba(0,0,0,0.6) 100%)'}}></div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
