import React, { useState, useEffect, useRef } from 'react';
import { 
  Map as MapIcon, 
  Users, 
  TrendingUp, 
  Gavel, 
  Vote, 
  AlertTriangle, 
  Menu, 
  X, 
  ChevronRight,
  Globe,
  Layers,
  FileText,
  Info,
  Search,
  Plus,
  Minus,
  Maximize,
  Loader,
  BarChart2,
  MapPin
} from 'lucide-react';

// --- Données extraites du rapport ---

const sections = [
  { id: 'geo', title: 'Observatoire Satellite', icon: <Globe size={20} /> },
  { id: 'socio', title: 'Données Sociales', icon: <Users size={20} /> },
  { id: 'elections', title: 'Historique', icon: <Vote size={20} /> },
  { id: 'justice', title: 'Justice', icon: <Gavel size={20} /> },
];

const socioData = [
  { label: 'Chômage (2022)', value: '20.0%', desc: 'En baisse relative' },
  { label: 'Chômage Jeunes', value: '46.0%', desc: '15-24 ans' },
  { label: 'Taux Pauvreté', value: '37%', desc: 'Sous seuil nat.' },
  { label: 'Vie Chère', value: '+37%', desc: 'Alimentaire vs Métropole' },
];

// Liste COMPLÈTE des 24 Communes avec coordonnées GPS (Lat/Lng)
const fiefsData = [
  // NORD
  { name: 'Saint-Denis', region: 'NORD', status: 'Bastion PS', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -20.88, lng: 55.45, mayor: 'Ericka Bareigts' },
  { name: 'Sainte-Marie', region: 'NORD', status: 'Droite fragilisée', trend: 'Droite / LR', color: 'bg-blue-600', lat: -20.895, lng: 55.55, mayor: 'Richard Nirlo' },
  { name: 'Sainte-Suzanne', region: 'NORD', status: 'Citadelle PCR', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -20.905, lng: 55.605, mayor: 'Maurice Gironcel' },
  
  // EST
  { name: 'Saint-André', region: 'EST', status: 'Bascule Historique', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -20.96, lng: 55.65, mayor: 'Joé Bédier' },
  { name: 'Bras-Panon', region: 'EST', status: 'Stabilité', trend: 'Droite / LR', color: 'bg-blue-600', lat: -20.995, lng: 55.675, mayor: 'Jeannick Atchapa' },
  { name: 'Saint-Benoît', region: 'EST', status: 'Instable', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -21.035, lng: 55.715, mayor: 'Patrice Selly' },
  { name: 'La Plaine des Palmistes', region: 'EST', status: 'Fief RN', trend: 'RN', color: 'bg-indigo-600', lat: -21.135, lng: 55.63, mayor: 'Johnny Payet' },
  { name: 'Sainte-Rose', region: 'EST', status: 'Divers', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.125, lng: 55.795, mayor: 'Michel Vergoz' },
  { name: 'Salazie', region: 'EST', status: 'Cirque', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.025, lng: 55.538, mayor: 'Stéphane Fouassin' },

  // OUEST
  { name: 'Le Port', region: 'OUEST', status: 'Cœur Rouge', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -20.94, lng: 55.29, mayor: 'Olivier Hoarau' },
  { name: 'La Possession', region: 'OUEST', status: 'Transition', trend: 'Centre / Div', color: 'bg-amber-500', lat: -20.93, lng: 55.33, mayor: 'Vanessa Miranville' },
  { name: 'Saint-Paul', region: 'OUEST', status: 'Fief PLR', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -21.01, lng: 55.27, mayor: 'Emmanuel Séraphin' },
  { name: 'Trois-Bassins', region: 'OUEST', status: 'Rural', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.105, lng: 55.295, mayor: 'Daniel Pausé' },
  { name: 'Saint-Leu', region: 'OUEST', status: 'Post-Thierry Robert', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.165, lng: 55.285, mayor: 'Bruno Domen' },
  
  // SUD
  { name: 'Les Avirons', region: 'SUD', status: 'Calme', trend: 'Droite / LR', color: 'bg-blue-600', lat: -21.24, lng: 55.33, mayor: 'Eric Ferrère' },
  { name: 'L\'Étang-Salé', region: 'SUD', status: 'Bascule', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -21.265, lng: 55.365, mayor: 'Mathieu Hoarau' },
  { name: 'Saint-Louis', region: 'SUD', status: 'Renouveau', trend: 'Centre / Div', color: 'bg-blue-600', lat: -21.29, lng: 55.405, mayor: 'Juliana M\'Doihoma' },
  { name: 'Cilaos', region: 'SUD', status: 'Cirque', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.135, lng: 55.47, mayor: 'Jacques Técher' },
  { name: 'L\'Entre-Deux', region: 'SUD', status: 'Village', trend: 'Centre / Div', color: 'bg-blue-600', lat: -21.245, lng: 55.47, mayor: 'Bachil Valy' },
  { name: 'Saint-Pierre', region: 'SUD', status: 'Bastion LR', trend: 'Droite / LR', color: 'bg-blue-600', lat: -21.33, lng: 55.475, mayor: 'Michel Fontaine' },
  { name: 'Le Tampon', region: 'SUD', status: 'Fief TAK', trend: 'Centre / Div', color: 'bg-blue-600', lat: -21.28, lng: 55.51, mayor: 'André Thien Ah Koon' },
  { name: 'Petite-Île', region: 'SUD', status: 'Stable', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -21.35, lng: 55.56, mayor: 'Serge Hoareau' },
  { name: 'Saint-Joseph', region: 'SUD', status: 'Bastion PS', trend: 'Gauche / PCR', color: 'bg-red-500', lat: -21.375, lng: 55.615, mayor: 'Patrick Lebreton' },
  { name: 'Saint-Philippe', region: 'SUD', status: 'Sud Sauvage', trend: 'Centre / Div', color: 'bg-amber-500', lat: -21.355, lng: 55.76, mayor: 'Olivier Rivière' },
];

// --- Composant Carte Leaflet ---
const LeafletMap = ({ data, onSelectCity, selectedCity }) => {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const [isLoaded, setIsLoaded] = useState(false);

  useEffect(() => {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
    document.head.appendChild(link);

    const script = document.createElement("script");
    script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    script.async = true;
    script.onload = () => setIsLoaded(true);
    document.body.appendChild(script);

    return () => {
      document.head.removeChild(link);
      document.body.removeChild(script);
    };
  }, []);

  useEffect(() => {
    if (isLoaded && mapRef.current && !mapInstanceRef.current && window.L) {
      const L = window.L;

      const map = L.map(mapRef.current, {
        center: [-21.115, 55.536],
        zoom: 10,
        zoomControl: false, 
        attributionControl: false
      });

      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri',
        maxZoom: 17
      }).addTo(map);

      // Ajout des labels
      data.forEach(city => {
        const markerHtml = `
          <div class="flex items-center justify-center pointer-events-auto">
            <span class="text-white text-[11px] font-bold drop-shadow-[0_2px_3px_rgba(0,0,0,0.9)] whitespace-nowrap bg-black/20 px-1.5 py-0.5 rounded hover:bg-black/50 hover:scale-110 transition-all cursor-pointer border border-transparent hover:border-white/30">${city.name}</span>
          </div>
        `;

        const icon = L.divIcon({
          className: 'custom-label-icon', 
          html: markerHtml,
          iconSize: [100, 20],
          iconAnchor: [50, 10]
        });

        const marker = L.marker([city.lat, city.lng], { icon: icon }).addTo(map);
        marker.on('click', () => {
          onSelectCity(city);
        });
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);
      mapInstanceRef.current = map;
    }
  }, [isLoaded, data]);

  // Synchronisation de la carte quand une ville est sélectionnée (via menu ou clic)
  useEffect(() => {
    if (mapInstanceRef.current && selectedCity && window.L) {
      mapInstanceRef.current.flyTo([selectedCity.lat, selectedCity.lng], 13, { duration: 1.2 });
    } else if (mapInstanceRef.current && !selectedCity && window.L) {
        // Retour vue globale si désélection
        mapInstanceRef.current.flyTo([-21.115, 55.536], 10, { duration: 1.2 });
    }
  }, [selectedCity]);

  return (
    <div className="w-full h-full relative bg-slate-900">
      {!isLoaded && (
        <div className="absolute inset-0 flex items-center justify-center text-white">
          <Loader className="animate-spin mr-2" /> Chargement de la cartographie...
        </div>
      )}
      <div ref={mapRef} className="w-full h-full z-0" style={{background: '#0f172a'}}></div>
      <div className="absolute bottom-1 right-24 text-[10px] text-white/50 z-[1000] select-none pointer-events-none">Imagerie © Esri</div>
    </div>
  );
};

const App = () => {
  const [activeSection, setActiveSection] = useState('geo');
  const [selectedCity, setSelectedCity] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  // Calculs statistiques globaux
  const totalCommunes = fiefsData.length;
  const statsTrend = fiefsData.reduce((acc, curr) => {
    acc[curr.trend] = (acc[curr.trend] || 0) + 1;
    return acc;
  }, {});

  const handleCitySelect = (e) => {
    const cityName = e.target.value;
    if (cityName === "") {
      setSelectedCity(null);
    } else {
      const city = fiefsData.find(c => c.name === cityName);
      setSelectedCity(city);
    }
  };

  // Composant Carte Satellite (Vue Principale)
  const renderSatelliteView = () => (
    <div className="flex flex-col md:flex-row h-[calc(100vh-64px)] overflow-hidden">
      
      {/* Panneau Gauche Interactif */}
      <div className="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl">
        
        {/* Barre de Recherche / Sélecteur */}
        <div className="p-4 border-b border-slate-100 bg-slate-50">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
            <select 
              className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm appearance-none bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-slate-700 cursor-pointer shadow-sm hover:border-slate-400 transition-colors"
              onChange={handleCitySelect}
              value={selectedCity ? selectedCity.name : ""}
            >
              <option value="">Vue d'ensemble (Toute l'île)</option>
              <option disabled>──────────</option>
              {fiefsData.sort((a,b) => a.name.localeCompare(b.name)).map(city => (
                <option key={city.name} value={city.name}>{city.name}</option>
              ))}
            </select>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 flex flex-col">
          {selectedCity ? (
            // VUE DÉTAILLÉE : FICHE COMMUNE
            <div className="animate-fadeIn space-y-6">
              <div>
                <div className="flex justify-between items-start">
                   <h1 className="text-2xl font-extrabold text-slate-900 leading-tight">{selectedCity.name}</h1>
                   <button onClick={() => setSelectedCity(null)} className="text-slate-400 hover:text-slate-600 p-1"><X size={16}/></button>
                </div>
                <div className="flex items-center mt-2">
                    <MapPin size={14} className="text-slate-400 mr-1"/>
                    <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">{selectedCity.region}</span>
                </div>
              </div>

              {/* Indicateur Tendance */}
              <div className={`p-4 rounded-xl border-l-4 shadow-sm ${selectedCity.color.replace('bg-', 'border-').replace('600', '500').replace('500', '500')} bg-white border-slate-100`}>
                 <span className="text-xs text-slate-400 uppercase font-bold mb-1 block">Tendance Politique</span>
                 <div className="flex items-center">
                    <div className={`w-3 h-3 rounded-full mr-2 ${selectedCity.color}`}></div>
                    <span className="text-lg font-bold text-slate-800">{selectedCity.trend}</span>
                 </div>
              </div>

              <div className="space-y-4">
                <div className="p-4 rounded-lg bg-slate-50 border border-slate-100 hover:bg-slate-100 transition-colors">
                  <div className="text-xs text-slate-500 uppercase mb-1 font-semibold flex items-center">
                     <Users size={14} className="mr-1"/> Maire (Mandat 2020-2026)
                  </div>
                  <div className="font-bold text-slate-800 text-lg">
                    {selectedCity.mayor}
                  </div>
                </div>

                <div className="grid grid-cols-1 gap-3">
                  <div className="p-3 rounded-lg bg-slate-50 border border-slate-100">
                    <div className="text-xs text-slate-500 mb-1 font-semibold">Statut Politique</div>
                    <div className="font-medium text-slate-800">{selectedCity.status}</div>
                  </div>
                </div>
              </div>

              <div className="pt-6 border-t border-slate-100 text-center">
                 <div className="inline-flex items-center text-xs text-slate-400 bg-slate-50 px-3 py-1 rounded-full">
                    GPS: {selectedCity.lat}, {selectedCity.lng}
                 </div>
              </div>
            </div>
          ) : (
            // VUE GLOBALE : DASHBOARD ÎLE
            <div className="animate-fadeIn space-y-8">
              <div className="text-center pb-4 border-b border-slate-100">
                <h3 className="text-xl font-bold text-slate-800 flex items-center justify-center">
                  <Globe className="mr-2 text-blue-600" size={20}/> La Réunion
                </h3>
                <p className="text-sm text-slate-500 mt-1">Analyse Globale 2024</p>
              </div>

              {/* Stats Politiques Globales */}
              <div>
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center">
                    <BarChart2 size={12} className="mr-1"/> Répartition Maires ({totalCommunes})
                </h4>
                <div className="space-y-3">
                    <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center text-slate-700"><div className="w-2 h-2 rounded-full bg-red-500 mr-2"></div>Gauche / PCR</span>
                        <span className="font-bold">{statsTrend['Gauche / PCR'] || 0}</span>
                    </div>
                    <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center text-slate-700"><div className="w-2 h-2 rounded-full bg-blue-600 mr-2"></div>Droite / LR</span>
                        <span className="font-bold">{statsTrend['Droite / LR'] || 0}</span>
                    </div>
                    <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center text-slate-700"><div className="w-2 h-2 rounded-full bg-amber-500 mr-2"></div>Centre / Div</span>
                        <span className="font-bold">{statsTrend['Centre / Div'] || 0}</span>
                    </div>
                    <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center text-slate-700"><div className="w-2 h-2 rounded-full bg-indigo-600 mr-2"></div>RN</span>
                        <span className="font-bold">{statsTrend['RN'] || 0}</span>
                    </div>
                </div>
              </div>

              {/* Stats Sociales Globales */}
              <div>
                 <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center">
                    <AlertTriangle size={12} className="mr-1"/> Indicateurs Clés
                </h4>
                <div className="grid grid-cols-2 gap-3">
                    {socioData.map((stat, idx) => (
                        <div key={idx} className="bg-slate-50 p-3 rounded border border-slate-100">
                            <div className="text-xs text-slate-500 mb-1">{stat.label}</div>
                            <div className="text-lg font-bold text-slate-800">{stat.value}</div>
                            <div className="text-[10px] text-slate-400 italic">{stat.desc}</div>
                        </div>
                    ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Zone Carte Droite avec Leaflet */}
      <div className="w-full md:w-2/3 lg:w-3/4 relative bg-slate-900 overflow-hidden">
        <LeafletMap data={fiefsData} onSelectCity={setSelectedCity} selectedCity={selectedCity} />
      </div>
    </div>
  );

  return (
    <div className="h-screen bg-slate-900 font-sans text-slate-800 flex flex-col overflow-hidden">
      
      {/* HEADER */}
      <header className="h-16 bg-[#1a1c29] text-white flex items-center justify-between px-6 shadow-md z-30 flex-shrink-0 border-b border-slate-800">
        <div className="flex items-center space-x-3">
          <div className="bg-gradient-to-br from-red-600 to-red-700 w-8 h-8 rounded flex items-center justify-center font-bold text-xs shadow-inner">
            974
          </div>
          <h1 className="font-bold text-lg tracking-wide text-slate-100">
            Observatoire <span className="font-normal text-slate-400">Satellite 2000-2025</span>
          </h1>
        </div>

        {/* Navigation Desktop */}
        <nav className="hidden md:flex items-center space-x-1">
           {sections.map(section => (
             <button 
                key={section.id}
                onClick={() => setActiveSection(section.id)}
                className={`px-4 py-2 rounded text-sm font-medium transition-colors ${activeSection === section.id ? 'text-white bg-slate-700' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
             >
               {section.title}
             </button>
           ))}
        </nav>

        {/* Right Actions */}
        <div className="flex items-center space-x-3">
          <button className="hidden md:flex items-center px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-xs font-medium transition-colors text-slate-300">
            <FileText size={14} className="mr-2" /> Analyse
          </button>
          <button className="hidden md:flex items-center px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-xs font-medium transition-colors text-slate-300">
            <Gavel size={14} className="mr-2" /> Justice
          </button>
          <button className="md:hidden p-2" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
            <Menu />
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 bg-slate-100 relative">
        {activeSection === 'geo' ? renderSatelliteView() : (
          <div className="p-8 max-w-5xl mx-auto overflow-y-auto h-full">
             <div className="bg-white p-12 rounded-xl shadow text-center">
                <div className="inline-block p-4 rounded-full bg-slate-100 mb-4">
                  {sections.find(s => s.id === activeSection)?.icon}
                </div>
                <h2 className="text-2xl font-bold mb-2">Section {sections.find(s => s.id === activeSection)?.title}</h2>
                <p className="text-slate-500">Contenu détaillé disponible dans la version complète du rapport.</p>
                <button 
                  onClick={() => setActiveSection('geo')} 
                  className="mt-6 px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                >
                  Retour à la Carte Satellite
                </button>
             </div>
          </div>
        )}
      </main>

      {/* Mobile Menu Overlay */}
      {mobileMenuOpen && (
        <div className="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur text-white p-8 flex flex-col justify-center items-center space-y-6 md:hidden">
           <button onClick={() => setMobileMenuOpen(false)} className="absolute top-6 right-6">
             <X size={32} />
           </button>
           {sections.map(section => (
             <button 
               key={section.id}
               onClick={() => { setActiveSection(section.id); setMobileMenuOpen(false); }}
               className="text-xl font-bold flex items-center"
             >
               {section.icon} <span className="ml-3">{section.title}</span>
             </button>
           ))}
        </div>
      )}
    </div>
  );
};

export default App;
